# .github/workflows/build-and-release.yml
name: 编译并发布单文件工具

# 触发条件：推送标签（如 v1.0.0）时自动运行
on:
  push:
    tags:
      - 'v*'  # 匹配 v1.0.0、v2.1.1 等标签

jobs:
  build:
    runs-on: windows-latest
    steps:
      - name: 拉取代码
        uses: actions/checkout@v4

      - name: 安装 Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: 安装依赖
        run: |
          python -m pip install --upgrade pip
          pip install pyinstaller requests

      - name: 准备内置资源（如迷你ADB）
        run: |
          # 自动下载迷你ADB（Windows版）
          mkdir -p tools
          curl -L -o tools/adb.exe https://dl.google.com/android/repository/platform-tools-latest-windows.zip
          # 解压ADB（需系统自带tar，Windows 10+已内置）
          tar -xf tools/adb.exe -C tools platform-tools/adb.exe --strip-components=1
          rm tools/adb.exe  # 移除压缩包，仅保留adb.exe

      - name: 编译为单文件exe
        run: |
          pyinstaller --onefile ^
            --name "ydp_adb_tool" ^
            --add-data "tools/adb.exe;." ^  # 内置ADB到exe
            --hidden-import "requests" ^
            main.py

      - name: 生成发布说明
        run: |
          echo "有道词典笔ADB权限获取工具（单文件版）" > release_notes.txt
          echo "发布版本：${{ github.ref_name }}" >> release_notes.txt
          echo "使用说明：双击运行，按提示输入设备信息和密码即可" >> release_notes.txt

      - name: 发布到Release
        uses: softprops/action-gh-release@v2
        with:
          body_path: release_notes.txt  # 发布说明
          files: |
            dist/ydp_adb_tool.exe  # 单文件产物
          draft: false  # 直接发布，不设为草稿
          prerelease: false  # 不设为预发布
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}  # 自动获取仓库令牌

