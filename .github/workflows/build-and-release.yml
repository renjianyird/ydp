# .github/workflows/auto-build-release.yml
name: 自动编译并发布Release

on:
  push:
    branches:
      - main

jobs:
  build:
    runs-on: windows-latest
    steps:
      - name: 拉取代码
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: 生成自动版本号
        id: version
        run: |
          $date = Get-Date -Format "yyyyMMdd"
          $commitCount = (git rev-list --count origin/main --since "$date 00:00:00").ToString()
          $version = "v$date.$commitCount"
          echo "version=$version" >> $env:GITHUB_OUTPUT
          echo "自动生成版本号：$version"

      - name: 安装Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: 安装依赖
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: 准备内置ADB（PowerShell兼容版）
        run: |
          if (-not (Test-Path -Path "tools")) {
            New-Item -ItemType Directory -Path "tools" | Out-Null
            Write-Host "已创建tools目录"
          } else {
            Write-Host "tools目录已存在，跳过创建"
          }
          
          $adbZipUrl = "https://dl.google.com/android/repository/platform-tools-latest-windows.zip"
          $adbZipPath = "tools/adb.zip"
          Invoke-WebRequest -Uri $adbZipUrl -OutFile $adbZipPath -UseBasicParsing
          
          Expand-Archive -Path $adbZipPath -DestinationPath "tools" -Force
          
          $sourceAdb = "tools/platform-tools/adb.exe"
          $targetAdb = "tools/adb.exe"
          if (Test-Path -Path $sourceAdb) {
            Move-Item -Path $sourceAdb -Destination $targetAdb -Force
            Write-Host "已将adb.exe移动到tools根目录"
          } else {
            Write-Error "未找到adb.exe，解压失败"
            exit 1
          }
          
          Remove-Item -Path $adbZipPath -Force
          Remove-Item -Path "tools/platform-tools" -Recurse -Force
          Write-Host "已清理冗余文件"

      - name: 编译为单文件exe
        run: |
          pyinstaller --onefile `
            --name "ydp_adb_tool-${{ steps.version.outputs.version }}" `
            --add-data "tools/adb.exe;." `
            --hidden-import "requests" `
            main.py

      - name: 生成发布说明
        run: |
          echo "自动发布：${{ steps.version.outputs.version }}" > release_notes.txt
          echo "提交信息：${{ github.event.head_commit.message }}" >> release_notes.txt
          echo "发布时间：$(Get-Date -Format "yyyy-MM-dd HH:mm:ss")" >> release_notes.txt

      - name: 删除旧标签（若存在）
        run: |
          git tag -d ${{ steps.version.outputs.version }} 2>/dev/null || true
          git push origin --delete ${{ steps.version.outputs.version }} 2>/dev/null || true

      - name: 创建并推送新标签
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          git tag -a ${{ steps.version.outputs.version }} -m "自动发布版本 ${{ steps.version.outputs.version }}"
          git push origin ${{ steps.version.outputs.version }}

      - name: 发布到Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.version }}
          body_path: release_notes.txt
          files: |
            dist/ydp_adb_tool-${{ steps.version.outputs.version }}.exe
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
