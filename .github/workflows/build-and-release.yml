# .github/workflows/auto-build-release.yml
name: 自动编译并发布Release

on:
  push:
    branches:
      - main

jobs:
  build:
    runs-on: windows-latest
    steps:
      - name: 拉取代码
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: 生成自动版本号
        id: version
        run: |
          $date = Get-Date -Format "yyyyMMdd"
          $commitCount = (git rev-list --count origin/main --since "$date 00:00:00").ToString()
          $version = "v$date.$commitCount"
          echo "version=$version" >> $env:GITHUB_OUTPUT

      - name: 安装Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: 安装依赖
        run: |
          python -m pip install --upgrade pip
          pip install pyinstaller==6.3.0 requests==2.31.0

      - name: 准备内置ADB
        run: |
          if (-not (Test-Path "tools")) { New-Item -ItemType Directory -Path "tools" | Out-Null }
          Invoke-WebRequest -Uri "https://dl.google.com/android/repository/platform-tools-latest-windows.zip" -OutFile "tools/adb.zip" -UseBasicParsing
          Expand-Archive -Path "tools/adb.zip" -DestinationPath "tools" -Force
          Move-Item -Path "tools/platform-tools/adb.exe" -Destination "tools/adb.exe" -Force
          Remove-Item -Path "tools/adb.zip" -Force
          Remove-Item -Path "tools/platform-tools" -Recurse -Force

      - name: 编译为单文件exe
        run: |
          pyinstaller --onefile `
            --name "ydp_adb_tool-${{ steps.version.outputs.version }}" `
            --add-data "tools/adb.exe;." `
            main.py

      - name: 生成发布说明
        run: |
          "@自动发布：${{ steps.version.outputs.version }}`n提交信息：${{ github.event.head_commit.message }}`n发布时间：$(Get-Date -Format "yyyy-MM-dd HH:mm:ss")" | Out-File -FilePath "release_notes.txt" -Encoding utf8

      - name: 处理标签（跳过错误）
        run: |
          # 忽略标签不存在的错误，直接执行后续步骤
          try { git tag -d ${{ steps.version.outputs.version }} } catch {}
          try { git push origin --delete ${{ steps.version.outputs.version }} } catch {}

      - name: 创建并推送新标签
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          git tag -a ${{ steps.version.outputs.version }} -m "自动发布"
          git push origin ${{ steps.version.outputs.version }}

      - name: 发布到Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.version }}
          body_path: "release_notes.txt"
          files: "dist/ydp_adb_tool-${{ steps.version.outputs.version }}.exe"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
