# .github/workflows/auto-build-release.yml
name: 编译并发布工具（自动+手动）

# 触发条件：主分支推送自动运行 + 手动点击运行
on:
  push:
    branches:
      - main
  workflow_dispatch:  # 支持手动触发

jobs:
  build-and-release:
    runs-on: windows-latest
    steps:
      - name: 拉取仓库代码
        uses: actions/checkout@v4

      - name: 生成唯一版本号（时间戳格式）
        id: version
        run: |
          $version = Get-Date -Format "yyyyMMdd.HHmmss"
          echo "version=$version" >> $env:GITHUB_OUTPUT
          echo "当前版本号：$version"

      - name: 安装Python环境
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: 安装打包依赖
        run: |
          python -m pip install --upgrade pip
          pip install pyinstaller==6.3.0 requests==2.31.0

      - name: 下载并配置内置ADB
        run: |
          # 创建工具目录
          if (-not (Test-Path "tools")) {
            New-Item -ItemType Directory -Path "tools" | Out-Null
          }
          # 下载Android平台工具
          $adbZipUrl = "https://dl.google.com/android/repository/platform-tools-latest-windows.zip"
          $adbZipPath = "tools/adb.zip"
          Invoke-WebRequest -Uri $adbZipUrl -OutFile $adbZipPath -UseBasicParsing
          # 解压并提取adb.exe
          Expand-Archive -Path $adbZipPath -DestinationPath "tools" -Force
          Move-Item -Path "tools/platform-tools/adb.exe" -Destination "tools/adb.exe" -Force
          # 清理冗余文件
          Remove-Item -Path $adbZipPath -Force
          Remove-Item -Path "tools/platform-tools" -Recurse -Force

      - name: 打包为单文件EXE
        run: |
          pyinstaller --onefile `
            --name "ydp_adb_tool-${{ steps.version.outputs.version }}" `
            --add-data "tools/adb.exe;." `
            main.py

      - name: 生成发布说明
        run: |
          $releaseNote = @"
          工具版本：ydp_adb_tool-${{ steps.version.outputs.version }}
          发布时间：$(Get-Date -Format "yyyy-MM-dd HH:mm:ss")
          提交信息：${{ github.event.head_commit.message }}
          "@
          $releaseNote | Out-File -FilePath "release_notes.txt" -Encoding utf8

      - name: 发布到GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: "build-${{ steps.version.outputs.version }}"  # 自动生成唯一标签
          body_path: "release_notes.txt"
          files: "dist/ydp_adb_tool-${{ steps.version.outputs.version }}.exe"
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
